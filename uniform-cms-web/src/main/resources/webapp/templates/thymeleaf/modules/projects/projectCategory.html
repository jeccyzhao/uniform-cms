<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/default/layout" th:with="subTitle=${project.name}, menu='categories'">
	
<th:block layout:fragment="content">
    <div class="col-md-2">
        <th:block layout:include="modules/projects/menu/projectMenu"/>
    </div>
    <div class="col-md-10">
        <div class="panel panel-shadow panel-blue-cap">
            <div class="panel-heading panel-heading-transparent">
                <div style="color: #C8C9D1; padding: 3px 0; float:right;" th:text="${'Owner - ' + project.owner}">Owner</div>
                <h1 th:text="'\'' + ${project.name} + '\' - Categories'" style="line-height: 30px"></h1>
            </div>
            <div class="panel-body" style="padding: 0 10px 20px 10px;">
                <div class="pannel-toolbar" style="overflow: hidden">
                    <div style="float: left;">
                        <a href="#" class="btn btn-icon-button"
                           data-backdrop="true" data-toggle="modal" id="op_add">
                            <span class="icon icon-add"></span><span>Add</span>
                        </a>
                    </div>
                </div>
                <div id="table-filter" class="grid-alternating-rows n-table-hover n-jqxgrid-table n-grid-paging "></div>
            </div>
        </div>
    </div>

    <div th:include="modules/projects/popup/popupProjectCategory"></div>

    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        var tableColumns = constructTableColumns();
        $(function () {
            loadData("table-filter");
            $("#op_add").click(function() {
                showPopupDialog('m_projectCat');
            });
        });

        function loadData(container_id) {
            var projectId = /*[[${project.id}]]*/;
            sendAjaxRequest("projects/" + projectId + "/categories", 'GET', {}, function(data) {
                initJqxTable(container_id, tableColumns, rebuildData(data), true);
            });
        }

        function constructTableColumns () {
            var columns = [
                {text: 'ID', datafield: 'id', hidden: true},
                {text: 'D', columntype: 'textbox', datafield: 'delete', width: 24, filterable: false, editable: false, sortable: false},
                {text: 'C', columntype: 'textbox', datafield: 'undo', width: 24, filterable: false, editable: false, sortable: false},
                {text: 'S', columntype: 'textbox', datafield: 'edit', width: 24, filterable: false, editable: false, sortable: false},
                {text: 'Category Name', datafield: 'name', cellsalign: 'left', align: 'center', filterable: true},
                {text: 'Category Description', datafield: 'description', cellsalign: 'left', align: 'center', filterable: true},
                {text: 'Owner', datafield: 'owner', cellsalign: 'left', editable: false, align: 'center', filterable: true},
                {text: 'Creation Time', datafield: 'creationTime', editable: false, cellsalign: 'center', align: 'center',  width: 140, filterable: true},
                {text: 'Last Update Time', datafield: 'updateTime', editable: false, cellsalign:'center', align: 'center', width: 140, filterable: true}
            ];
            return columns;
        }

        function rebuildData (data) {
            if (data != null) {
                for (var i = 0; i < data.length; i++) {
                    data[i].creationTime = reformatDate(data[i].creationTime);
                    data[i].updateTime = reformatDate(data[i].updateTime);
                    data[i].undo = '<div class="n-row-indicated" onclick="reviseCategory(\'clean\');" title="Cleanup"><span class="icon icon-undo"></span></div>';
                    data[i].edit = '<div class="n-row-indicated" onclick="reviseCategory(\'update\');" title="Save"><span class="icon icon-save-as"></span></div>';
                    data[i].delete = '<div class="n-row-indicated" onclick="reviseCategory(\'delete\');" title="Delete"><span class="icon icon-delete"></span></div>';
                }
            }
            return data;
        }

        function reviseCategory (operationType) {
            var rowData = getCurrentGridRowData("table-filter");
            if (rowData != null) {
                switch (operationType) {
                    case "update":
                        updateRowWithConfirmation("", "", rowData, function(){
                        });
                        break;
                    case "delete":
                        updateRowWithConfirmation("", "", rowData, function(){
                        });
                        break;
                    case "clean":
                        updateRowWithConfirmation("", "", rowData, function(){
                        });
                        break;
                    default:
                        showErrorDialog("Operation (" + operationType + ") is not supported!");
                }
            }
        }

        function updateCategory(rowData) {
            if (rowData != null) {
                showConfirmationDialog(
                    "Do you want to update this column?",
                    "Column property would be updated to," + constructColumnInstructions(rowData),
                    function() {
                        // remove some unnecessary attribute from row data
                        rowData = removeObjectAttribute(rowData, ['delete', 'edit', 'uid', 'undo', 'uniqueid', 'visibleindex', 'boundindex', 'projectId', 'updateTime']);
                        sendAjaxRequest("projects/" + projectId + "/columns", 'PUT', JSON.stringify(rowData), function(data) {
                            updateGridRowData("table-filter", rebuildSingleColumnData(data));
                        }, "application/json; charset=utf-8");
                    }
                );
            }
        }

        function removeObjectAttribute (json_obj, attributes) {
            for (var i = 0; i < attributes.length; i++) {
                delete json_obj[attributes[i]];
            }
            return json_obj;
        }

        function deleteCategory (rowData) {
            if (rowData != null) {
                showConfirmationDialog(
                    "Do you want to delete this column?",
                    "Below column would be removed and including all relevant data in project table: " + constructColumnInstructions(rowData),
                    function() {
                        sendAjaxRequest("projects/" + projectId + "/columns/" + rowData.id, 'DELETE', {}, function(data) {
                            removeGridRowData("table-filter");
                        });
                    }
                );
            }
        }

        function cleanCategory (rowData) {
            if (rowData != null) {
                showConfirmationDialog(
                    "Do you want to cleanup the column?",
                    "It would cleanup all the revisions from editor.",
                    function() {
                        sendAjaxRequest("projects/" + projectId + "/columns", 'GET', {columnId: rowData.id}, function(data) {
                            if (data.length > 0) {
                                updateGridRowData("table-filter", rebuildSingleColumnData(data[0]));
                            }
                        });
                    }
                );
            }
        }

        /*]]>*/
    </script>
</th:block>
</html>